# IaC Wrapper Script for Terragrunt

## Overview

This unified wrapper script intercepts terraform/opentofu commands invoked by terragrunt to capture individual module logs instead of just the combined terragrunt output.

## Requirements

- **IaC Binary**: Set to `terraform` (configured via `IAC_BINARY` environment variable)

## Problem Statement

When running terragrunt with multiple subfolders (modules), the standard approach only captures the combined output from terragrunt. This makes it difficult to:
- Debug issues in specific modules
- Track individual module execution
- Parse logs for each subfolder independently

## Solution

The wrapper scripts:
1. Intercept terraform/opentofu commands called by terragrunt
2. Capture logs for each command in the appropriate format
3. Generate module-specific log files in each subfolder
4. Pass through all other commands unchanged

## How It Works

### Setup

1. **Wrapper Deployment (Terragrunt in Docker)**: The wrapper script is written to the workspace directory and copied into the container at `/tmp/`
2. **Environment Variable**: `TG_TF_PATH` is set to point to the wrapper script (for single-module execution)
3. **Command Line Flag**: For `run-all` or `run --all`, the `--tf-path` flag is passed explicitly
4. **Terragrunt Invocation**: When terragrunt runs, it invokes the wrapper instead of the actual terraform/opentofu binary.

### Command Interception

The wrapper intercepts the following commands:

#### Plan Command
- **Detects**: `plan -json -out=<file>`
- **Captures**: JSON output to `plan_log.jsonl` in each subfolder
- **Generates**: `plan_output.json` using `terraform show -json`
- **Result**: Each module has its own `plan_log.jsonl` and `plan_output.json`

#### Apply Command
- **Detects**: `apply -json`
- **Captures**: JSON output to `apply_log.jsonl` in each subfolder
- **Result**: Each module has its own `apply_log.jsonl`

#### Destroy Command
- **Detects**: `destroy -json`
- **Captures**: JSON output to `destroy_log.jsonl` in each subfolder
- **Result**: Each module has its own `destroy_log.jsonl`

#### Init Command
- **Captures**: Output to `init_log.jsonl` in each subfolder
- **Result**: Each module has its own `init_log.jsonl`

#### Show Command
- **Behavior**: Passes through without capturing
- **Reason**: Used internally by the wrapper to generate plan output

#### Other Commands
- **Behavior**: Pass through to the actual binary unchanged
- **Examples**: `validate`, `providers`, `version`, etc.

## File Structure Example

```
workspace/
├── module1/
│   ├── main.tf
│   ├── plan_log.jsonl      # Generated by wrapper
│   ├── plan_output.json    # Generated by wrapper
│   └── terragrunt.hcl
├── module2/
│   ├── main.tf
│   ├── apply_log.jsonl     # Generated by wrapper
│   └── terragrunt.hcl
└── module3/
    ├── main.tf
    ├── destroy_log.jsonl   # Generated by wrapper
    └── terragrunt.hcl
```

## Benefits

1. **Individual Module Logs**: Each module's execution is logged separately
2. **Consistent Format**: JSON logs for easy parsing
3. **Debugging**: Easier to identify which module failed and why
4. **Transparency**: No loss of information from the original terraform/opentofu output
5. **Backward Compatible**: Works with existing terragrunt configurations

## Implementation Details

### Wrapper Script

**iac-wrapper.sh**: A unified wrapper that supports both terraform and opentofu binaries

The script:
- Uses the `IAC_BINARY` environment variable to determine which binary to use (terraform or tofu) - Defaults to `terraform`
- Uses bash for maximum compatibility
- Sets `set -e` for proper error propagation
- Uses `tee` to capture logs while displaying output
- Preserves exit codes using `${PIPESTATUS[0]}`

### Environment Variables

- **`TG_TF_PATH`** (new) / `TERRAGRUNT_TFPATH` (deprecated): Points terragrunt to the wrapper script instead of the actual binary
- **`IAC_BINARY`**: Tells the wrapper which IaC binary to use (`terraform` or `tofu`)
- The wrapper then calls the actual binary at `/usr/local/bin/<binary-name>`

### Important: Terragrunt CLI Redesign (v0.90+)

Starting with Terragrunt v0.90+, there was a significant CLI redesign that affects how the wrapper script is invoked.

**Official References**:
- [CLI Rules](https://terragrunt.gruntwork.io/docs/reference/cli/rules/) - Documents the `--tf-path` flag and `TG_TF_PATH` environment variable
- [Run Queue](https://terragrunt.gruntwork.io/docs/features/run-queue/) - Important considerations for `run-all` command
- [Strict Mode](https://terragrunt.gruntwork.io/docs/reference/strict-mode/) - Documents deprecation of old `*-all` commands

#### Key Changes:
1. **Environment Variable**: `TERRAGRUNT_TFPATH` → `TG_TF_PATH` (new name)
2. **Run-all Command Syntax** (version dependent):
   - **Terragrunt 0.51.8 (used in CI)**: `terragrunt run-all <cmd>`
   - **Terragrunt 0.91.5+ (newer)**: `terragrunt run --all -- <cmd>`

#### Critical Behavior with `run-all`:

**For single module execution**, the `TG_TF_PATH` environment variable works as expected:
```bash
export TG_TF_PATH=/path/to/wrapper.sh
terragrunt plan -json -out=tf.plan
```

**For multi-module execution** (`run-all`), the environment variable alone is NOT sufficient. You **MUST** pass the `--tf-path` flag explicitly:
```bash
# ❌ This may not work reliably:
export TG_TF_PATH=/path/to/wrapper.sh
terragrunt run-all plan -json -out=tf.plan  # (0.51.8)
terragrunt run --all -- plan -json -out=tf.plan  # (0.91.5+)

# ✅ This works correctly:
terragrunt run-all --terragrunt-tfpath=/path/to/wrapper.sh plan -json -out=tf.plan  # (0.51.8)
terragrunt run --all --tf-path=/path/to/wrapper.sh -- plan -json -out=tf.plan  # (0.91.5+)
```

**Reason**: The new `run-all` command handles the terraform binary path differently than single-module execution. The flag ensures the wrapper is consistently used across all modules.

**Note**: This behavior is not explicitly documented in the official Terragrunt documentation but was discovered through testing. The official documentation mentions the flag and `TG_TF_PATH`/`TERRAGRUNT_TFPATH` environment variables, but doesn't specify that the flag is required for `run-all` to work reliably with wrapper scripts.

**Flag Names by Version**:
- **Terragrunt 0.51.8**: Use `--terragrunt-tfpath` (older naming convention)
- **Terragrunt 0.91.5+**: Use `--tf-path` (newer naming convention)


## Example Usage

### Single Module
When running:
```bash
export TG_TF_PATH=/tmp/iac-wrapper.sh
export IAC_BINARY=terraform
terragrunt plan -json -out=tf.plan
```

Terragrunt will:
1. Invoke the wrapper: `<wrapper> plan -json -out=tf.plan`
2. The wrapper captures output to `plan_log.jsonl` in the module's directory
3. The wrapper runs `terraform show -json tf.plan > plan_output.json`
4. Module ends up with `plan_log.jsonl` and `plan_output.json`

### Multi-Module (Run All)
When running (Terragrunt 0.51.8):
```bash
export IAC_BINARY=terraform
terragrunt run-all --terragrunt-tfpath=/tmp/iac-wrapper.sh plan -json -out=tf.plan
```

Or (Terragrunt 0.91.5+):
```bash
export IAC_BINARY=terraform
terragrunt run --all --tf-path=/tmp/iac-wrapper.sh -- plan -json -out=tf.plan
```

Terragrunt will:
1. Discover all modules
2. For each module, invoke the wrapper: `<wrapper> plan -json -out=tf.plan`
3. The wrapper captures output to `plan_log.jsonl` in that module's directory
4. The wrapper runs `terraform show -json tf.plan > plan_output.json`
5. Each module ends up with its own `plan_log.jsonl` and `plan_output.json` **in isolation**

**Note**: The explicit flag (`--terragrunt-tfpath` for 0.51.8 or `--tf-path` for 0.91.5+) is required for `run-all` to ensure the wrapper is used consistently across all modules.


## Troubleshooting

### Wrapper Not Found
- **Issue**: Terragrunt can't find the wrapper
- **Solution**: 
  - For single module: Check that `TG_TF_PATH` environment variable is set correctly
  - For run-all: Check that `--tf-path` flag is passed in the command
  - Ensure the file is executable

### Logs Not Generated
- **Issue**: No log files in module directories
- **Solutions**: 
  - Verify the wrapper is being invoked (check terragrunt output)
  - For `run-all`, ensure you're using `--tf-path` flag, not just the environment variable
  - Check that the wrapper has execute permissions

### Permission Denied
- **Issue**: Wrapper can't be executed
- **Solution**: Ensure the wrapper is copied with execute permissions in the container

### Exit Code Issues
- **Issue**: Terragrunt reports success when terraform failed
- **Solution**: Check that `${PIPESTATUS[0]}` is used to preserve exit codes

